<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HolographicMemory SOA Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header class="sh-header" style="display:flex;align-items:center;justify-content:space-between;margin:16px 0;padding:16px 24px;border:1px solid #E4E4E7;border-radius:12px;background:#fafafa;box-shadow:0 1px 3px 0 rgb(0 0 0 / 0.1);">
            <div class="header-left" style="display:flex;align-items:center;gap:16px;">
                <img src="/assets/images/sh-logo-dark.svg" alt="SmartHaus" style="height:56px;width:140px;object-fit:contain;">
                <div class="header-title">
                    <h1 style="font-family:Inter,system-ui,sans-serif;font-size:1.777rem;margin:0;color:#000120;">ðŸš€ HolographicMemory SOA Dashboard</h1>
                    <div style="font-family:Inter,system-ui,sans-serif;color:#52525B;font-size:0.875rem;">Analytics & Monitoring</div>
                </div>
            </div>
            <div class="header-right" style="display:flex;align-items:center;gap:16px;">
                <nav class="nav" style="display:flex;align-items:center;gap:16px;margin-right:8px;">
                    <a id="nav-dashboard" href="#" style="color:#111827;text-decoration:none;font-family:Inter,sans-serif;font-weight:500;font-size:0.875rem;padding:6px 8px;border-radius:6px;">Dashboard</a>
                    <a id="nav-terminal" href="#" style="color:#111827;text-decoration:none;font-family:Inter,sans-serif;font-weight:500;font-size:0.875rem;padding:6px 8px;border-radius:6px;">Terminal</a>
                    <a id="nav-analytics" href="#" style="color:#111827;text-decoration:none;font-family:Inter,sans-serif;font-weight:500;font-size:0.875rem;padding:6px 8px;border-radius:6px;">Analytics</a>
                    <a id="nav-status" href="#" style="color:#111827;text-decoration:none;font-family:Inter,sans-serif;font-weight:500;font-size:0.875rem;padding:6px 8px;border-radius:6px;">Status</a>
                    <a id="nav-docs" href="#" style="color:#111827;text-decoration:none;font-family:Inter,sans-serif;font-weight:500;font-size:0.875rem;padding:6px 8px;border-radius:6px;">Docs</a>
                </nav>
                <div class="status-indicator" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:#10B981;color:#fff;border-radius:9999px;font:500 0.875rem Inter,sans-serif;">
                    <span style="display:inline-block;width:8px;height:8px;background:#fff;border-radius:50%"></span>
                    <span>System Online</span>
                </div>
            </div>
        </header>
        <header class="dashboard-header">
            <!-- retaining existing header styles for compatibility -->
        </header>
        
        <nav class="dashboard-nav">
            <a href="#overview" class="nav-item active">Overview</a>
            <a href="#services" class="nav-item">Services</a>
            <a href="#gpu" class="nav-item">GPU</a>
            <a href="#compression" class="nav-item">Compression</a>
            <a href="#monitoring" class="nav-item">Monitoring</a>
            <a href="#logs" class="nav-item">Logs</a>
        </nav>
        
        <main class="dashboard-main">
            <section id="overview" class="dashboard-section active">
                <h2>System Overview</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>Services</h3>
                        <div class="metric-value">5/5</div>
                        <div class="metric-status healthy">Healthy</div>
                    </div>
                    <div class="metric-card">
                        <h3>GPU Status</h3>
                        <div class="metric-value">Active</div>
                        <div class="metric-status healthy">Available</div>
                    </div>
                    <div class="metric-card">
                        <h3>Memory Usage</h3>
                        <div class="metric-value">2.1GB</div>
                        <div class="metric-status warning">65%</div>
                    </div>
                    <div class="metric-card">
                        <h3>Compression Ratio</h3>
                        <div class="metric-value">1475x</div>
                        <div class="metric-status healthy">Excellent</div>
                    </div>
                </div>
            </section>
            
            <section id="services" class="dashboard-section">
                <h2>Service Status</h2>
                <div class="services-grid">
                    <div class="service-card">
                        <h3>Orchestrator</h3>
                        <div class="service-status healthy">Running</div>
                        <div class="service-metrics">
                            <span>Uptime: 2h 15m</span>
                            <span>Requests: 1,247</span>
                        </div>
                    </div>
                    <div class="service-card">
                        <h3>Router</h3>
                        <div class="service-status healthy">Running</div>
                        <div class="service-metrics">
                            <span>Uptime: 2h 15m</span>
                            <span>Routes: 892</span>
                        </div>
                    </div>
                    <div class="service-card">
                        <h3>Vault</h3>
                        <div class="service-status healthy">Running</div>
                        <div class="service-metrics">
                            <span>Uptime: 2h 15m</span>
                            <span>Stored: 156 items</span>
                        </div>
                    </div>
                    <div class="service-card">
                        <h3>Telemetry</h3>
                        <div class="service-status healthy">Running</div>
                        <div class="service-metrics">
                            <span>Uptime: 2h 15m</span>
                            <span>Metrics: 2,341</span>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="gpu" class="dashboard-section">
                <h2>GPU Performance</h2>
                <div class="gpu-metrics">
                    <div class="gpu-card">
                        <h3>Metal Shaders</h3>
                        <div class="shader-list">
                            <div class="shader-item">âœ… enhanced_vector_add</div>
                            <div class="shader-item">âœ… batch_holographic_store</div>
                            <div class="shader-item">âœ… holographic_similarity_search</div>
                            <div class="shader-item">âœ… holographic_fft_transform</div>
                            <div class="shader-item">âœ… gpu_sparse_encoding</div>
                            <div class="shader-item">âœ… gpu_entropy_coding</div>
                        </div>
                    </div>
                    <div class="gpu-card">
                        <h3>Performance Metrics</h3>
                        <canvas id="gpuChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </section>
            
            <section id="compression" class="dashboard-section">
                <h2>Compression Pipeline</h2>
                <div class="compression-metrics">
                    <div class="compression-card">
                        <h3>Algorithm Performance</h3>
                        <div class="algorithm-stats">
                            <div class="algorithm-item">
                                <span>Huffman</span>
                                <span>1.99x</span>
                            </div>
                            <div class="algorithm-item">
                                <span>LZW</span>
                                <span>3.70x</span>
                            </div>
                            <div class="algorithm-item">
                                <span>Arithmetic</span>
                                <span>1475.00x</span>
                            </div>
                            <div class="algorithm-item">
                                <span>Wavelet</span>
                                <span>5.00x</span>
                            </div>
                        </div>
                    </div>
                    <div class="compression-card">
                        <h3>Compression History</h3>
                        <canvas id="compressionChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </section>
            
            <section id="monitoring" class="dashboard-section">
                <h2>System Monitoring</h2>
                <div class="charts-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:16px;">
                    <div class="chart-card" style="background:#fff;border:1px solid #E4E4E7;border-radius:8px;padding:12px;">
                        <h3>CPU Usage (%)</h3>
                        <canvas id="cpuChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-card" style="background:#fff;border:1px solid #E4E4E7;border-radius:8px;padding:12px;">
                        <h3>Memory Usage (%)</h3>
                        <canvas id="memChart" width="400" height="200"></canvas>
                    </div>
                </div>
                <div class="monitoring-grid">
                    <div class="monitor-card">
                        <h3>CPU Usage</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 45%"></div>
                        </div>
                        <span>45%</span>
                    </div>
                    <div class="monitor-card">
                        <h3>Memory Usage</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 65%"></div>
                        </div>
                        <span>65%</span>
                    </div>
                    <div class="monitor-card">
                        <h3>GPU Usage</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 30%"></div>
                        </div>
                        <span>30%</span>
                    </div>
                    <div class="monitor-card">
                        <h3>Network I/O</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 20%"></div>
                        </div>
                        <span>20%</span>
                    </div>
                </div>
            </section>
            
            <section id="logs" class="dashboard-section">
                <h2>System Logs</h2>
                <div class="logs-container">
                    <div class="log-entry info">
                        <span class="log-time">2023-01-01 16:53:53</span>
                        <span class="log-level">INFO</span>
                        <span class="log-message">GPU backend initialized for advanced kernels</span>
                    </div>
                    <div class="log-entry success">
                        <span class="log-time">2023-01-01 16:53:53</span>
                        <span class="log-level">SUCCESS</span>
                        <span class="log-message">Advanced compression algorithms implemented successfully</span>
                    </div>
                    <div class="log-entry warning">
                        <span class="log-time">2023-01-01 16:52:01</span>
                        <span class="log-level">WARNING</span>
                        <span class="log-message">Memory usage approaching threshold</span>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
    <script>
        // Authentication check
        if (sessionStorage.getItem('soa_authenticated') !== 'true') {
            window.location.href = '/soa_login.html';
        }
      // Discover main dashboard port dynamically
      async function discoverMainDashboardPort() {
        const commonPorts = [8080, 8081, 8082, 8083, 8084, 8085, 8086, 8087, 8088, 8089, 8090, 8091, 8092, 8093, 8094, 8095, 8100, 8101, 8102, 8103, 8104, 8105, 8106, 8107, 8108, 8109, 8110, 8111, 8112, 8113, 8114, 8115];
        for (const port of commonPorts) {
          try {
            const response = await fetch(`http://localhost:${port}/api/soa-config`, { 
              method: 'GET',
              timeout: 1000 
            });
            if (response.ok) {
              return port;
            }
          } catch (e) {
            // Continue to next port
          }
        }
        return null;
      }
      
      // Wire header nav using SOA config if available
      (async function() {
        try {
          await fetch('/api/status', { cache: 'no-store' });
          const mainDashboardPort = await discoverMainDashboardPort();
          if (!mainDashboardPort) {
            console.warn('Could not discover main dashboard port');
            return;
          }
          const cfgResp = await fetch(`http://localhost:${mainDashboardPort}/api/soa-config`);
          if (cfgResp.ok) {
            const data = await cfgResp.json();
            const ports = data.service_ports || {};
            const el = (id) => document.getElementById(id);
            const navUrls = data.navigation_urls || {};
            
            // Wire all navigation links using the registry
            if (el('nav-dashboard') && navUrls.dashboard) el('nav-dashboard').href = navUrls.dashboard;
            if (el('nav-terminal') && navUrls.terminal) el('nav-terminal').href = navUrls.terminal;
            if (el('nav-analytics') && navUrls.analytics) el('nav-analytics').href = navUrls.analytics;
            if (el('nav-status') && navUrls.status) el('nav-status').href = navUrls.status;
            if (el('nav-docs') && navUrls.docs) el('nav-docs').href = navUrls.docs;

            if (ports.metrics_service) {
              initCharts(ports.metrics_service);
            }
          }
        } catch (_) { /* ignore */ }
      })();

      let cpuChart, memChart, gpuChart, netChart;
      function initCharts(metricsPort) {
        cpuChart = new Chart(document.getElementById('cpuChart').getContext('2d'), { type: 'line', data: { datasets: [{ label:'CPU %', data: [], borderColor:'#2563eb' }]}, options: chartOpts() });
        memChart = new Chart(document.getElementById('memChart').getContext('2d'), { type: 'line', data: { datasets: [{ label:'Mem %', data: [], borderColor:'#16a34a' }]}, options: chartOpts() });
        gpuChart = new Chart(document.getElementById('gpuChart').getContext('2d'), { type: 'line', data: { datasets: [{ label:'GPU %', data: [], borderColor:'#a855f7' }]}, options: chartOpts() });
        netChart = new Chart(document.getElementById('compressionChart').getContext('2d'), { type: 'line', data: { datasets: [{ label:'Net Sent', data: [], borderColor:'#f59e0b' }, { label:'Net Recv', data: [], borderColor:'#ef4444' }]}, options: chartOpts() });

        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${proto}://localhost:${metricsPort}/ws`);
        ws.onmessage = (e) => {
          try {
            const msg = JSON.parse(e.data);
            if (msg.type !== 'metrics') return;
            const t = msg.ts ? new Date(msg.ts*1000) : new Date();
            pushData(cpuChart, t, msg.cpu ?? msg.cpu_percent ?? 0);
            pushData(memChart, t, msg.memory?.percent ?? msg.memory_percent ?? 0);
            pushData(gpuChart, t, msg.gpu?.utilization ?? 0);
            pushData(netChart, t, msg.network?.bytes_sent ?? msg.net_sent ?? 0, 0);
            pushData(netChart, t, msg.network?.bytes_recv ?? msg.net_recv ?? 0, 1);
          } catch(_){}
        };
      }

      function chartOpts(){
        return {
          responsive: true,
          parsing: false,
          scales: { x: { type: 'time', time: { unit: 'second' }}, y: { beginAtZero: true } },
          plugins: { zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } } }
        };
      }
      function pushData(chart, t, v, datasetIndex=0){
        const ds = chart.data.datasets[datasetIndex];
        ds.data.push({ x: t, y: v });
        if (ds.data.length > 200) ds.data.shift();
        chart.update('none');
      }
    </script>
    <script src="/static/js/dashboard.js"></script>
</body>
</html>
