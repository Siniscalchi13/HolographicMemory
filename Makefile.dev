# Makefile.dev - Development targets

# Variables
PY?=python3
PIP?=$(PY) -m pip
VENV_DIR?=venv
VENV_PY?=$(VENV_DIR)/bin/python
VENV_PIP?=$(VENV_PY) -m pip
DEV_PORT?=8080
DEV_HOST?=0.0.0.0

# Development targets
.PHONY: dev-setup dev-test dev-build dev-native dev-api dev-soa dev-benchmark dev-demo dev-clean

dev-setup:
	@echo "ğŸ”§ Setting up development environment..."
	@echo "ğŸ“¦ Creating virtual environment..."
	$(PY) -m venv $(VENV_DIR)
	@echo "â¬†ï¸ Upgrading pip, wheel, setuptools..."
	$(VENV_PIP) install --upgrade pip wheel setuptools
	@echo "ğŸ“š Installing API dependencies..."
	$(VENV_PIP) install -r services/holographic-memory/api/requirements.txt
	@echo "ğŸ”§ Installing core service..."
	$(VENV_PIP) install -e services/holographic-memory/core
	@echo "ğŸ§ª Installing development dependencies..."
	$(VENV_PIP) install pytest pytest-cov pytest-asyncio
	$(VENV_PIP) install black flake8 isort mypy
	@echo "ğŸ”¨ Building native extensions..."
	$(MAKE) dev-native
	@echo "âœ… Development environment setup complete!"

dev-test:
	@echo "ğŸ§ª Running development tests..."
	@echo "ğŸ” Testing core service..."
	@cd services/holographic-memory/core && $(VENV_PY) -m pytest -v --cov=holographicfs --cov-report=html
	@echo "ğŸŒ Testing API service..."
	@cd services/holographic-memory/api && $(VENV_PY) -m pytest -v
	@echo "ğŸ§® Testing math-core service..."
	@cd services/math-core && $(VENV_PY) -m pytest -v
	@echo "ğŸ”„ Testing router service..."
	@cd services/router && $(VENV_PY) -m pytest -v
	@echo "ğŸ“Š Testing telemetry service..."
	@cd services/telemetry && $(VENV_PY) -m pytest -v
	@echo "ğŸ”’ Testing vault service..."
	@cd services/vault && $(VENV_PY) -m pytest -v
	@echo "âœ… All development tests passed!"

dev-build:
	@echo "ğŸ”¨ Building development components..."
	@echo "ğŸ“¦ Building core service..."
	@cd services/holographic-memory/core && $(VENV_PY) -m build
	@echo "ğŸ”§ Building native extensions..."
	$(MAKE) dev-native
	@echo "âœ… Development build complete!"

dev-native:
	@echo "ğŸ”§ Building native extensions for development..."
	@which clang++ > /dev/null || (echo "âŒ clang++ not found. Install Xcode Command Line Tools: xcode-select --install" && exit 1)
	@which cmake > /dev/null || (echo "âŒ cmake not found. Install with: brew install cmake" && exit 1)
	@echo "ğŸ—ï¸ Building GPU backend with CMake..."
	@cd services/holographic-memory/core/native/holographic && \
		mkdir -p build && \
		cd build && \
		cmake .. -DCMAKE_BUILD_TYPE=Debug -DBUILD_METAL=ON -DBUILD_3D=ON && \
		make -j$(shell sysctl -n hw.ncpu)
	@echo "âœ… Native extensions built successfully!"

dev-api:
	@echo "ğŸš€ Starting development API server..."
	@echo "ğŸŒ Server will be available at http://$(DEV_HOST):$(DEV_PORT)"
	@echo "ğŸ“š API documentation at http://$(DEV_HOST):$(DEV_PORT)/docs"
	@$(VENV_PY) -m uvicorn services.holographic-memory.api.app_soa:app --reload --host $(DEV_HOST) --port $(DEV_PORT)

dev-soa:
	@echo "ğŸŒ Starting development SOA system..."
	@echo "ğŸ”§ Starting all services in development mode..."
	@$(VENV_PY) main.py

dev-benchmark:
	@echo "ğŸ“Š Running development benchmarks..."
	@echo "ğŸ” Running GPU performance benchmarks..."
	@$(VENV_PY) -c "import sys; sys.path.append('services/holographic-memory/core/native/holographic/build'); import holographic_gpu; print('GPU platforms:', holographic_gpu.available_platforms())"
	@echo "ğŸ§® Running mathematical validation benchmarks..."
	@$(VENV_PY) tools/validate_accuracy.py
	@echo "âœ… Development benchmarks complete!"

dev-demo:
	@echo "ğŸ¬ Running development demos..."
	@echo "ğŸ¯ Running end-to-end demo..."
	@$(VENV_PY) tools/demo_end_to_end.py
	@echo "âœ… Development demos complete!"

dev-clean:
	@echo "ğŸ§¹ Cleaning development artifacts..."
	@rm -rf **/__pycache__ build dist .pytest_cache
	@rm -rf services/holographic-memory/core/*.egg-info
	@rm -rf services/holographic-memory/core/native/holographic/build
	@rm -rf htmlcov .coverage
	@echo "âœ… Development cleanup complete!"
